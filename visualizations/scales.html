<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scale Graph - Hierarchical Knowledge Layers</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(180deg, #030712 0%, #0f172a 100%);
            color: #e5e7eb;
            min-height: 100vh;
            overflow: hidden;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 1rem 2rem;
            background: rgba(3, 7, 18, 0.9);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 2rem;
            border-bottom: 1px solid #1f2937;
        }

        h1 {
            font-size: 1.2rem;
            color: #60a5fa;
        }

        .search-box {
            flex: 1;
            max-width: 500px;
        }

        #question-input {
            width: 100%;
            padding: 0.5rem 1rem;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 6px;
            color: #e5e7eb;
            font-family: inherit;
            font-size: 0.85rem;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .view-btn {
            padding: 0.5rem 1rem;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 6px;
            color: #9ca3af;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-btn:hover, .view-btn.active {
            background: #374151;
            color: #e5e7eb;
            border-color: #60a5fa;
        }

        #canvas {
            width: 100vw;
            height: 100vh;
            padding-top: 60px;
        }

        /* Scale layers */
        .scale-layer {
            fill-opacity: 0.03;
            stroke-opacity: 0.3;
            stroke-width: 1;
        }

        .scale-label {
            font-size: 14px;
            font-weight: 700;
            fill-opacity: 0.5;
        }

        /* Nodes */
        .node circle {
            cursor: pointer;
            transition: all 0.3s;
        }

        .node circle:hover {
            filter: brightness(1.3);
        }

        .node.highlighted circle {
            filter: url(#glow);
            stroke: white;
            stroke-width: 2;
        }

        .node text {
            font-size: 9px;
            fill: #9ca3af;
            pointer-events: none;
        }

        .node.highlighted text {
            fill: #e5e7eb;
            font-weight: 600;
        }

        /* Links */
        .link {
            fill: none;
            stroke: #374151;
            stroke-width: 1;
            stroke-opacity: 0.4;
        }

        .link.highlighted {
            stroke: #60a5fa;
            stroke-width: 2;
            stroke-opacity: 1;
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.8rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 300px;
            z-index: 1000;
        }

        .tooltip.visible { opacity: 1; }
        .tooltip h4 { color: #60a5fa; margin-bottom: 0.5rem; }
        .tooltip .badge {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-right: 0.5rem;
        }

        /* Scale colors */
        .quantum { fill: #ef4444; stroke: #ef4444; }
        .electronic { fill: #8b5cf6; stroke: #8b5cf6; }
        .structural { fill: #06b6d4; stroke: #06b6d4; }
        .descriptive { fill: #22c55e; stroke: #22c55e; }
        .application { fill: #f59e0b; stroke: #f59e0b; }

        .badge.quantum { background: #ef4444; }
        .badge.electronic { background: #8b5cf6; }
        .badge.structural { background: #06b6d4; }
        .badge.descriptive { background: #22c55e; }

        /* Stats panel */
        .stats-panel {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background: rgba(17, 24, 39, 0.9);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.75rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            gap: 2rem;
            margin-bottom: 0.3rem;
        }

        .stat-label { color: #6b7280; }
        .stat-value { color: #60a5fa; font-weight: 600; }

        /* Legend */
        .legend {
            position: fixed;
            top: 80px;
            right: 1rem;
            background: rgba(17, 24, 39, 0.9);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 1rem;
        }

        .legend-title {
            font-size: 0.7rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
            font-size: 0.8rem;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Scale Graph</h1>
        <div class="search-box">
            <input type="text" id="question-input" placeholder="Enter question or concept...">
        </div>
        <div class="view-toggle">
            <a href="scales.html" class="view-btn active">Scales</a>
            <a href="hierarchy.html" class="view-btn">Hierarchy</a>
            <a href="../funnel.html" class="view-btn">Funnel</a>
        </div>
    </div>

    <svg id="canvas"></svg>

    <div class="tooltip" id="tooltip"></div>

    <div class="legend">
        <div class="legend-title">Knowledge Scales</div>
        <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div> QUANTUM</div>
        <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6"></div> ELECTRONIC</div>
        <div class="legend-item"><div class="legend-dot" style="background:#06b6d4"></div> STRUCTURAL</div>
        <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div> DESCRIPTIVE</div>
    </div>

    <div class="stats-panel" id="stats">
        <div class="stat-row">
            <span class="stat-label">Nodes</span>
            <span class="stat-value" id="stat-nodes">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Edges</span>
            <span class="stat-value" id="stat-edges">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Target</span>
            <span class="stat-value" id="stat-target">-</span>
        </div>
    </div>

    <script>
    const scaleColors = {
        'QUANTUM': '#ef4444',
        'ELECTRONIC': '#8b5cf6',
        'STRUCTURAL': '#06b6d4',
        'DESCRIPTIVE': '#22c55e',
        'APPLICATION': '#f59e0b'
    };

    const scaleY = {
        'QUANTUM': 0.8,
        'ELECTRONIC': 0.6,
        'STRUCTURAL': 0.4,
        'DESCRIPTIVE': 0.2
    };

    let svg, width, height;
    let simulation;
    let nodes = [], links = [];

    function init() {
        width = window.innerWidth;
        height = window.innerHeight;

        svg = d3.select('#canvas')
            .attr('width', width)
            .attr('height', height);

        // Add glow filter
        const defs = svg.append('defs');
        const filter = defs.append('filter')
            .attr('id', 'glow')
            .attr('x', '-50%').attr('y', '-50%')
            .attr('width', '200%').attr('height', '200%');

        filter.append('feGaussianBlur')
            .attr('stdDeviation', '4')
            .attr('result', 'coloredBlur');

        const feMerge = filter.append('feMerge');
        feMerge.append('feMergeNode').attr('in', 'coloredBlur');
        feMerge.append('feMergeNode').attr('in', 'SourceGraphic');

        // Arrow marker
        defs.append('marker')
            .attr('id', 'arrow')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 15)
            .attr('refY', 0)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', '#374151');

        // Scale layer backgrounds
        const layerGroup = svg.append('g').attr('class', 'layers');
        Object.entries(scaleY).forEach(([scale, yRatio]) => {
            const y = height * yRatio;
            layerGroup.append('rect')
                .attr('class', 'scale-layer')
                .attr('x', 0)
                .attr('y', y - 60)
                .attr('width', width)
                .attr('height', 120)
                .attr('fill', scaleColors[scale])
                .attr('stroke', scaleColors[scale]);

            layerGroup.append('text')
                .attr('class', 'scale-label')
                .attr('x', 20)
                .attr('y', y + 5)
                .attr('fill', scaleColors[scale])
                .text(scale);
        });

        svg.append('g').attr('class', 'links');
        svg.append('g').attr('class', 'nodes');

        // Load default
        document.getElementById('question-input').value = 'Why is copper sulfate blue?';
        tracePath('Why is copper sulfate blue?');
    }

    async function tracePath(query) {
        try {
            const response = await fetch(`/api/trace?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            if (!data.error) {
                renderGraph(data);
            }
        } catch (e) {
            console.error('API error:', e);
        }
    }

    function renderGraph(data) {
        // Update stats
        document.getElementById('stat-nodes').textContent = Object.keys(data.all_nodes).length;
        document.getElementById('stat-edges').textContent = data.all_edges.length;
        document.getElementById('stat-target').textContent = data.target.slice(0, 20);

        // Prepare data
        nodes = Object.values(data.all_nodes).map(n => ({
            ...n,
            x: width / 2 + (Math.random() - 0.5) * width * 0.6,
            y: height * (scaleY[n.scale] || 0.5) + (Math.random() - 0.5) * 80
        }));

        const nodeMap = new Map(nodes.map(n => [n.id, n]));

        links = data.all_edges
            .filter(e => nodeMap.has(e.source) && nodeMap.has(e.target))
            .map(e => ({
                source: nodeMap.get(e.source),
                target: nodeMap.get(e.target)
            }));

        // Force simulation - strong Y force to keep in layers
        if (simulation) simulation.stop();

        simulation = d3.forceSimulation(nodes)
            .force('link', d3.forceLink(links).id(d => d.id).distance(60).strength(0.3))
            .force('charge', d3.forceManyBody().strength(-100))
            .force('x', d3.forceX(width / 2).strength(0.05))
            .force('y', d3.forceY(d => height * (scaleY[d.scale] || 0.5)).strength(0.8))
            .force('collision', d3.forceCollide().radius(20));

        // Render links
        const linkElements = svg.select('.links')
            .selectAll('line')
            .data(links, d => `${d.source.id}-${d.target.id}`)
            .join('line')
            .attr('class', 'link')
            .attr('marker-end', 'url(#arrow)');

        // Render nodes
        const nodeElements = svg.select('.nodes')
            .selectAll('g')
            .data(nodes, d => d.id)
            .join(
                enter => {
                    const g = enter.append('g').attr('class', 'node');
                    g.append('circle')
                        .attr('r', d => 5 + Math.sqrt(d.count || 1) * 0.8)
                        .attr('class', d => d.scale.toLowerCase());
                    g.append('text')
                        .attr('dx', 10)
                        .attr('dy', 3)
                        .text(d => d.id.length > 25 ? d.id.slice(0, 23) + '...' : d.id);
                    return g;
                },
                update => update,
                exit => exit.remove()
            )
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended));

        // Interactions
        const tooltip = document.getElementById('tooltip');

        nodeElements
            .on('mouseover', (event, d) => {
                // Highlight
                nodeElements.classed('highlighted', n => n.id === d.id);
                linkElements.classed('highlighted', l =>
                    l.source.id === d.id || l.target.id === d.id);

                // Tooltip
                tooltip.innerHTML = `
                    <h4>${d.id}</h4>
                    <span class="badge ${d.scale.toLowerCase()}">${d.scale}</span>
                    <span class="badge" style="background:#374151">Depth: ${d.depth}</span>
                    <p style="margin-top:0.5rem;color:#9ca3af;">
                        Mentions: ${d.count || 0}<br>
                        ${d.is_target ? '‚≠ê Target concept' : ''}
                    </p>
                `;
                tooltip.classList.add('visible');
                tooltip.style.left = (event.pageX + 15) + 'px';
                tooltip.style.top = (event.pageY + 15) + 'px';
            })
            .on('mouseout', () => {
                nodeElements.classed('highlighted', false);
                linkElements.classed('highlighted', false);
                tooltip.classList.remove('visible');
            })
            .on('click', (event, d) => {
                // Re-trace from clicked node
                document.getElementById('question-input').value = d.id;
                tracePath(d.id);
            });

        // Target node glow
        nodeElements.filter(d => d.is_target)
            .classed('highlighted', true)
            .select('circle')
            .attr('r', d => 8 + Math.sqrt(d.count || 1));

        // Tick
        simulation.on('tick', () => {
            linkElements
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            nodeElements.attr('transform', d => `translate(${d.x},${d.y})`);
        });
    }

    function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
    }

    function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
    }

    function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
    }

    // Events
    document.getElementById('question-input').addEventListener('keypress', e => {
        if (e.key === 'Enter' && e.target.value.trim()) {
            tracePath(e.target.value.trim());
        }
    });

    window.addEventListener('resize', () => {
        width = window.innerWidth;
        height = window.innerHeight;
        svg.attr('width', width).attr('height', height);
    });

    window.addEventListener('load', init);
    </script>
</body>
</html>
