<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Funnel - Path Tracer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: #030712;
            color: #e5e7eb;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            padding: 1.5rem 2rem;
            background: linear-gradient(180deg, #111827 0%, transparent 100%);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 {
            font-size: 1.5rem;
            color: #60a5fa;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .search-box {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        #question-input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: #1f2937;
            border: 2px solid #374151;
            border-radius: 8px;
            color: #e5e7eb;
            font-family: inherit;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }

        #question-input:focus {
            border-color: #60a5fa;
        }

        #question-input::placeholder {
            color: #6b7280;
        }

        #trace-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #trace-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        }

        .main-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: calc(100vh - 150px);
        }

        .sidebar {
            background: #111827;
            padding: 1.5rem;
            border-right: 1px solid #1f2937;
            overflow-y: auto;
        }

        .sidebar h3 {
            color: #9ca3af;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
        }

        .layer-legend {
            margin-bottom: 2rem;
        }

        .layer-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 6px;
            margin-bottom: 0.25rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .layer-item:hover {
            background: #1f2937;
        }

        .layer-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .layer-dot.quantum { background: #ef4444; box-shadow: 0 0 10px #ef4444; }
        .layer-dot.electronic { background: #8b5cf6; box-shadow: 0 0 10px #8b5cf6; }
        .layer-dot.structural { background: #06b6d4; box-shadow: 0 0 10px #06b6d4; }
        .layer-dot.descriptive { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .layer-dot.application { background: #f59e0b; box-shadow: 0 0 10px #f59e0b; }

        .layer-name {
            font-size: 0.85rem;
        }

        .layer-count {
            margin-left: auto;
            background: #374151;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .path-list {
            margin-top: 1rem;
        }

        .path-step {
            padding: 0.6rem 0.75rem;
            background: #1f2937;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            border-left: 3px solid #374151;
            cursor: pointer;
            transition: all 0.2s;
        }

        .path-step:hover {
            background: #374151;
        }

        .path-step.active {
            border-left-color: #60a5fa;
            background: #1e3a5f;
        }

        .path-step.target {
            border-left-color: #f59e0b;
            background: #422006;
        }

        .step-num {
            color: #6b7280;
            margin-right: 0.5rem;
        }

        .canvas-container {
            position: relative;
            overflow: hidden;
        }

        #funnel-canvas {
            width: 100%;
            height: 100%;
        }

        /* Node styles */
        .node {
            cursor: pointer;
        }

        .node circle {
            transition: all 0.3s;
        }

        .node.highlighted circle {
            filter: url(#glow);
        }

        .node text {
            font-size: 10px;
            fill: #e5e7eb;
            pointer-events: none;
        }

        .link {
            fill: none;
            stroke: #374151;
            stroke-width: 1.5;
            stroke-opacity: 0.6;
        }

        .link.highlighted {
            stroke: #60a5fa;
            stroke-width: 2.5;
            stroke-opacity: 1;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.8rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 300px;
            z-index: 1000;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip h4 {
            color: #60a5fa;
            margin-bottom: 0.5rem;
        }

        .tooltip .scale-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-bottom: 0.5rem;
        }

        .tooltip .prereqs {
            color: #9ca3af;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        /* Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        /* Stats bar */
        .stats-bar {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(17, 24, 39, 0.9);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            display: flex;
            gap: 2rem;
            font-size: 0.8rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #60a5fa;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.7rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Knowledge Funnel</h1>
        <p class="subtitle">Trace prerequisite paths through the knowledge graph</p>
        <div class="search-box">
            <input type="text" id="question-input" placeholder="Ask a question... (e.g., Why is copper sulfate blue?)">
            <button id="trace-btn">Trace Path</button>
        </div>
        <div class="view-toggle" style="display:flex;gap:0.5rem;">
            <a href="visualizations/scales.html" style="padding:0.5rem 1rem;background:#1f2937;border:1px solid #374151;border-radius:6px;color:#9ca3af;text-decoration:none;font-size:0.8rem;">Scales</a>
            <a href="visualizations/hierarchy.html" style="padding:0.5rem 1rem;background:#1f2937;border:1px solid #374151;border-radius:6px;color:#9ca3af;text-decoration:none;font-size:0.8rem;">Hierarchy</a>
            <a href="funnel.html" style="padding:0.5rem 1rem;background:#374151;border:1px solid #60a5fa;border-radius:6px;color:#e5e7eb;text-decoration:none;font-size:0.8rem;">Funnel</a>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <h3>Scale Layers</h3>
            <div class="layer-legend" id="layer-legend">
                <div class="layer-item" data-scale="quantum">
                    <div class="layer-dot quantum"></div>
                    <span class="layer-name">QUANTUM</span>
                    <span class="layer-count" id="count-quantum">0</span>
                </div>
                <div class="layer-item" data-scale="electronic">
                    <div class="layer-dot electronic"></div>
                    <span class="layer-name">ELECTRONIC</span>
                    <span class="layer-count" id="count-electronic">0</span>
                </div>
                <div class="layer-item" data-scale="structural">
                    <div class="layer-dot structural"></div>
                    <span class="layer-name">STRUCTURAL</span>
                    <span class="layer-count" id="count-structural">0</span>
                </div>
                <div class="layer-item" data-scale="descriptive">
                    <div class="layer-dot descriptive"></div>
                    <span class="layer-name">DESCRIPTIVE</span>
                    <span class="layer-count" id="count-descriptive">0</span>
                </div>
                <div class="layer-item" data-scale="application">
                    <div class="layer-dot application"></div>
                    <span class="layer-name">APPLICATION</span>
                    <span class="layer-count" id="count-application">0</span>
                </div>
            </div>

            <h3>Learning Path</h3>
            <div class="path-list" id="path-list">
                <p style="color:#6b7280;font-size:0.8rem;">Enter a question to see the path...</p>
            </div>
        </div>

        <div class="canvas-container">
            <svg id="funnel-canvas"></svg>
            <div class="tooltip" id="tooltip"></div>
            <div class="stats-bar" id="stats-bar" style="display:none;">
                <div class="stat">
                    <div class="stat-value" id="stat-nodes">0</div>
                    <div class="stat-label">Concepts</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="stat-edges">0</div>
                    <div class="stat-label">Connections</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="stat-depth">0</div>
                    <div class="stat-label">Max Depth</div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Sample data (will be replaced by API call)
    const sampleData = {
        "target": "Crystal Field Theory",
        "all_nodes": {
            "Crystal Field Theory": {"id": "Crystal Field Theory", "scale": "ELECTRONIC", "depth": 0, "count": 165, "pagerank": 0.00166, "is_target": true},
            "Molecular Orbital Theory": {"id": "Molecular Orbital Theory", "scale": "ELECTRONIC", "depth": 1, "count": 143, "pagerank": 0.00297, "is_target": false},
            "Point Group Symmetry": {"id": "Point Group Symmetry", "scale": "STRUCTURAL", "depth": 1, "count": 3, "pagerank": 0.00024, "is_target": false},
            "Electronic Configuration Of Transition Metals": {"id": "Electronic Configuration Of Transition Metals", "scale": "ELECTRONIC", "depth": 1, "count": 47, "pagerank": 0, "is_target": false},
            "D-Orbital Splitting": {"id": "D-Orbital Splitting", "scale": "ELECTRONIC", "depth": 1, "count": 3, "pagerank": 0, "is_target": false},
            "Atomic Orbitals": {"id": "Atomic Orbitals", "scale": "QUANTUM", "depth": 2, "count": 89, "pagerank": 0.001, "is_target": false},
            "Electron Configuration": {"id": "Electron Configuration", "scale": "QUANTUM", "depth": 2, "count": 120, "pagerank": 0.0015, "is_target": false},
            "Chemical Bonding": {"id": "Chemical Bonding", "scale": "ELECTRONIC", "depth": 2, "count": 129, "pagerank": 0.0029, "is_target": false},
            "Symmetry Operations": {"id": "Symmetry Operations", "scale": "STRUCTURAL", "depth": 2, "count": 44, "pagerank": 0.0007, "is_target": false},
            "Quantum Numbers": {"id": "Quantum Numbers", "scale": "QUANTUM", "depth": 3, "count": 50, "pagerank": 0.0005, "is_target": false},
            "Wave Functions": {"id": "Wave Functions", "scale": "QUANTUM", "depth": 3, "count": 30, "pagerank": 0.0003, "is_target": false},
            "Periodic Trends": {"id": "Periodic Trends", "scale": "DESCRIPTIVE", "depth": 2, "count": 74, "pagerank": 0.012, "is_target": false}
        },
        "all_edges": [
            {"source": "Molecular Orbital Theory", "target": "Crystal Field Theory"},
            {"source": "Point Group Symmetry", "target": "Crystal Field Theory"},
            {"source": "Electronic Configuration Of Transition Metals", "target": "Crystal Field Theory"},
            {"source": "D-Orbital Splitting", "target": "Crystal Field Theory"},
            {"source": "Atomic Orbitals", "target": "Molecular Orbital Theory"},
            {"source": "Electron Configuration", "target": "Molecular Orbital Theory"},
            {"source": "Chemical Bonding", "target": "Molecular Orbital Theory"},
            {"source": "Symmetry Operations", "target": "Point Group Symmetry"},
            {"source": "Atomic Orbitals", "target": "Electronic Configuration Of Transition Metals"},
            {"source": "Quantum Numbers", "target": "Atomic Orbitals"},
            {"source": "Wave Functions", "target": "Atomic Orbitals"},
            {"source": "Periodic Trends", "target": "Electronic Configuration Of Transition Metals"},
            {"source": "Electron Configuration", "target": "Periodic Trends"}
        ]
    };

    // Scale colors
    const scaleColors = {
        'QUANTUM': '#ef4444',
        'ELECTRONIC': '#8b5cf6',
        'STRUCTURAL': '#06b6d4',
        'DESCRIPTIVE': '#22c55e',
        'APPLICATION': '#f59e0b'
    };

    const scaleY = {
        'QUANTUM': 0.85,
        'ELECTRONIC': 0.65,
        'STRUCTURAL': 0.45,
        'DESCRIPTIVE': 0.25,
        'APPLICATION': 0.1
    };

    let svg, simulation, nodes, links, nodeElements, linkElements;

    function initVisualization() {
        const container = document.querySelector('.canvas-container');
        const width = container.clientWidth;
        const height = container.clientHeight;

        svg = d3.select('#funnel-canvas')
            .attr('width', width)
            .attr('height', height);

        // Clear previous
        svg.selectAll('*').remove();

        // Add glow filter
        const defs = svg.append('defs');
        const filter = defs.append('filter')
            .attr('id', 'glow')
            .attr('x', '-50%')
            .attr('y', '-50%')
            .attr('width', '200%')
            .attr('height', '200%');

        filter.append('feGaussianBlur')
            .attr('stdDeviation', '3')
            .attr('result', 'coloredBlur');

        const feMerge = filter.append('feMerge');
        feMerge.append('feMergeNode').attr('in', 'coloredBlur');
        feMerge.append('feMergeNode').attr('in', 'SourceGraphic');

        // Arrow marker
        defs.append('marker')
            .attr('id', 'arrowhead')
            .attr('viewBox', '-0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('orient', 'auto')
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .append('path')
            .attr('d', 'M 0,-5 L 10,0 L 0,5')
            .attr('fill', '#374151');

        // Funnel background layers
        const layerGroup = svg.append('g').attr('class', 'layers');
        Object.entries(scaleY).forEach(([scale, yRatio]) => {
            const y = height * yRatio;
            const funnelWidth = width * (0.3 + 0.5 * (1 - yRatio)); // wider at top

            layerGroup.append('rect')
                .attr('x', (width - funnelWidth) / 2)
                .attr('y', y - 40)
                .attr('width', funnelWidth)
                .attr('height', 80)
                .attr('fill', scaleColors[scale])
                .attr('opacity', 0.05)
                .attr('rx', 8);
        });

        // Link group
        svg.append('g').attr('class', 'links');

        // Node group
        svg.append('g').attr('class', 'nodes');
    }

    function renderGraph(data) {
        const container = document.querySelector('.canvas-container');
        const width = container.clientWidth;
        const height = container.clientHeight;

        // Convert data to D3 format
        nodes = Object.values(data.all_nodes).map(n => ({
            ...n,
            x: width / 2 + (Math.random() - 0.5) * 200,
            y: height * scaleY[n.scale] || height * 0.5
        }));

        links = data.all_edges.map(e => ({
            source: e.source,
            target: e.target
        }));

        // Update stats
        document.getElementById('stat-nodes').textContent = nodes.length;
        document.getElementById('stat-edges').textContent = links.length;
        document.getElementById('stat-depth').textContent = Math.max(...nodes.map(n => n.depth));
        document.getElementById('stats-bar').style.display = 'flex';

        // Update layer counts
        const scaleCounts = {};
        nodes.forEach(n => {
            const s = n.scale.toLowerCase();
            scaleCounts[s] = (scaleCounts[s] || 0) + 1;
        });
        Object.entries(scaleCounts).forEach(([scale, count]) => {
            const el = document.getElementById(`count-${scale}`);
            if (el) el.textContent = count;
        });

        // Update path list
        const pathList = document.getElementById('path-list');
        const sortedNodes = [...nodes].sort((a, b) => b.depth - a.depth);
        pathList.innerHTML = sortedNodes.map((n, i) => `
            <div class="path-step ${n.is_target ? 'target' : ''}" data-id="${n.id}">
                <span class="step-num">${sortedNodes.length - i}.</span>
                ${n.id.length > 25 ? n.id.slice(0, 23) + '...' : n.id}
            </div>
        `).join('');

        // Add click handlers to path items
        document.querySelectorAll('.path-step').forEach(el => {
            el.addEventListener('click', () => highlightNode(el.dataset.id));
        });

        // Create force simulation
        simulation = d3.forceSimulation(nodes)
            .force('link', d3.forceLink(links).id(d => d.id).distance(80))
            .force('charge', d3.forceManyBody().strength(-200))
            .force('y', d3.forceY(d => height * scaleY[d.scale]).strength(0.5))
            .force('x', d3.forceX(width / 2).strength(0.1))
            .force('collision', d3.forceCollide().radius(30));

        // Render links
        linkElements = svg.select('.links')
            .selectAll('path')
            .data(links)
            .join('path')
            .attr('class', 'link')
            .attr('marker-end', 'url(#arrowhead)');

        // Render nodes
        nodeElements = svg.select('.nodes')
            .selectAll('g')
            .data(nodes)
            .join('g')
            .attr('class', 'node')
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended));

        nodeElements.append('circle')
            .attr('r', d => 8 + Math.sqrt(d.count) * 0.5)
            .attr('fill', d => scaleColors[d.scale])
            .attr('stroke', d => d.is_target ? '#fff' : 'none')
            .attr('stroke-width', d => d.is_target ? 3 : 0);

        nodeElements.append('text')
            .attr('dx', 12)
            .attr('dy', 4)
            .text(d => d.id.length > 20 ? d.id.slice(0, 18) + '...' : d.id);

        // Tooltip
        const tooltip = document.getElementById('tooltip');
        nodeElements
            .on('mouseover', (event, d) => {
                tooltip.innerHTML = `
                    <h4>${d.id}</h4>
                    <span class="scale-badge" style="background:${scaleColors[d.scale]}">${d.scale}</span>
                    <p>Mentions: ${d.count} | Depth: ${d.depth}</p>
                    ${d.pagerank > 0 ? `<p>PageRank: ${d.pagerank.toFixed(4)}</p>` : ''}
                `;
                tooltip.classList.add('visible');
                tooltip.style.left = (event.pageX + 15) + 'px';
                tooltip.style.top = (event.pageY + 15) + 'px';

                highlightNode(d.id);
            })
            .on('mouseout', () => {
                tooltip.classList.remove('visible');
                clearHighlights();
            });

        // Update positions on tick
        simulation.on('tick', () => {
            linkElements.attr('d', d => {
                const dx = d.target.x - d.source.x;
                const dy = d.target.y - d.source.y;
                return `M${d.source.x},${d.source.y} L${d.target.x},${d.target.y}`;
            });

            nodeElements.attr('transform', d => `translate(${d.x},${d.y})`);
        });

        // Animate entry
        nodeElements.style('opacity', 0)
            .transition()
            .delay((d, i) => i * 50)
            .duration(500)
            .style('opacity', 1);
    }

    function highlightNode(nodeId) {
        // Highlight node
        nodeElements.classed('highlighted', d => d.id === nodeId);

        // Highlight connected edges
        linkElements.classed('highlighted', d => d.source.id === nodeId || d.target.id === nodeId);

        // Highlight path step
        document.querySelectorAll('.path-step').forEach(el => {
            el.classList.toggle('active', el.dataset.id === nodeId);
        });
    }

    function clearHighlights() {
        nodeElements.classed('highlighted', false);
        linkElements.classed('highlighted', false);
    }

    function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
    }

    function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
    }

    function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
    }

    async function tracePath(question) {
        console.log('Tracing:', question);

        document.getElementById('trace-btn').textContent = 'Tracing...';
        document.getElementById('trace-btn').classList.add('loading');

        try {
            // Try API first
            const response = await fetch(`/api/trace?q=${encodeURIComponent(question)}`);
            if (response.ok) {
                const data = await response.json();
                if (data.error) {
                    console.warn('API error:', data.error);
                    renderGraph(sampleData);  // fallback
                } else {
                    renderGraph(data);
                }
            } else {
                console.warn('API not available, using sample data');
                renderGraph(sampleData);
            }
        } catch (e) {
            console.warn('API error:', e, '- using sample data');
            renderGraph(sampleData);
        }

        document.getElementById('trace-btn').textContent = 'Trace Path';
        document.getElementById('trace-btn').classList.remove('loading');
    }

    // Event listeners
    document.getElementById('trace-btn').addEventListener('click', () => {
        const question = document.getElementById('question-input').value;
        if (question.trim()) {
            tracePath(question);
        }
    });

    document.getElementById('question-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const question = e.target.value;
            if (question.trim()) {
                tracePath(question);
            }
        }
    });

    // Initialize
    window.addEventListener('load', () => {
        initVisualization();
        // Load default example
        document.getElementById('question-input').value = 'Why is copper sulfate blue?';
        tracePath('Why is copper sulfate blue?');
    });

    window.addEventListener('resize', () => {
        initVisualization();
        if (nodes && nodes.length > 0) {
            renderGraph({ all_nodes: Object.fromEntries(nodes.map(n => [n.id, n])), all_edges: links });
        }
    });
    </script>
</body>
</html>
